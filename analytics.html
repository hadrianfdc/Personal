<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Analytics</title>
    <link rel="stylesheet" href="assets/css/analytics.css">
</head>
<body>
    <div id="passwordModal" class="password-modal show">
        <div class="password-content">
            <h2>Enter Password</h2>
            <p>Please enter the admin password to access the analytics dashboard</p>
            <input type="password" id="passwordInput" class="password-input" placeholder="Enter password">
            <br>
            <button id="submitPassword" class="password-button">Access Dashboard</button>
            <p id="passwordError" style="color: red; margin-top: 10px; display: none;">Incorrect password</p>
        </div>
    </div>

    <div id="analyticsContent" class="container" style="display: none;">
        <h1>Chat Analytics Dashboard</h1>
        
        <div class="tab-buttons">
            <button id="dashboardTab" class="tab-btn active">Dashboard</button>
            <button id="usersTab" class="tab-btn">User Details</button>
            <button id="refreshBtn" class="refresh-btn"><span>Refresh Data</span></button>
            <button id="exportBtn" class="export-btn"><span>Export CSV</span></button>
        </div>
        
        <div id="dashboardTabContent" class="tab-content active">
            <div id="loading" class="loading">
                <p>Loading analytics data...</p>
            </div>
            
            <div id="analyticsGrid" class="analytics-grid" style="display: none;">
                <div class="metric-card">
                    <div class="metric-value" id="totalUsers">-</div>
                    <div class="metric-label">Total Users</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalChats">-</div>
                    <div class="metric-label">Total Chat Sessions</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalMessages">-</div>
                    <div class="metric-label">Total Messages</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgMessages">-</div>
                    <div class="metric-label">Avg Messages/User</div>
                </div>
            </div>
        </div>
        
        <div id="usersTabContent" class="tab-content">
            <div id="usersLoading" class="loading">
                <p>Loading user details...</p>
            </div>
            
            <div id="usersTableContainer" style="display: none;">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Company</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Total Chats</th>
                            <th>Total Messages</th>
                            <th>Created At</th>
                            <th>Last Active</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- User data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="errorMessage" class="error-message" style="display: none;">
            Failed to load analytics data. Please try again later.
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
          apiKey: "FIREBASE_API_KEY_PLACEHOLDER",
          authDomain: "my-portfolio-cb501.firebaseapp.com",
          projectId: "my-portfolio-cb501",
          storageBucket: "my-portfolio-cb501.firebasestorage.app",
          messagingSenderId: "291781785974",
          appId: "1:291781785974:web:16e697f1962c3a805ee257",
          measurementId: "G-RVTDSR5GVV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const PASSWORD = 't3mPa$$word102221';
        let passwordModal = document.getElementById('passwordModal');
        let passwordInput = document.getElementById('passwordInput');
        let submitButton = document.getElementById('submitPassword');
        let passwordError = document.getElementById('passwordError');
        let analyticsContent = document.getElementById('analyticsContent');
        let loading = document.getElementById('loading');
        let analyticsGrid = document.getElementById('analyticsGrid');
        let errorMessage = document.getElementById('errorMessage');
        let usersLoading = document.getElementById('usersLoading');
        let usersTableContainer = document.getElementById('usersTableContainer');
        let usersTableBody = document.getElementById('usersTableBody');
        let dashboardTab = document.getElementById('dashboardTab');
        let usersTab = document.getElementById('usersTab');
        let dashboardTabContent = document.getElementById('dashboardTabContent');
        let usersTabContent = document.getElementById('usersTabContent');
        let refreshBtn = document.getElementById('refreshBtn');
        let exportBtn = document.getElementById('exportBtn');

        let usersData = []; // Store user data for export

        // Tab switching
        dashboardTab.addEventListener('click', () => {
            dashboardTab.classList.add('active');
            usersTab.classList.remove('active');
            dashboardTabContent.classList.add('active');
            usersTabContent.classList.remove('active');
        });

        usersTab.addEventListener('click', () => {
            usersTab.classList.add('active');
            dashboardTab.classList.remove('active');
            usersTabContent.classList.add('active');
            dashboardTabContent.classList.remove('active');
            if (usersData.length === 0) {
                loadUserDetails();
            }
        });

        // Refresh button
        refreshBtn.addEventListener('click', async () => {
            refreshBtn.classList.add('loading');
            
            // If user details tab is active, show loading state for table
            if (usersTabContent.classList.contains('active')) {
                usersTableContainer.style.display = 'none';
                usersLoading.querySelector('p').textContent = 'Refreshing user data...';
                usersLoading.style.display = 'block';
            }
            
            try {
                // Load analytics data first
                await loadAnalytics();
                
                // If user details tab is active, load user details
                if (usersTabContent.classList.contains('active')) {
                    await loadUserDetails();
                }
            } catch (error) {
                console.error('Error during refresh:', error);
            } finally {
                // Remove loading state from refresh button
                refreshBtn.classList.remove('loading');
            }
        });

        // Export button
        exportBtn.addEventListener('click', () => {
            exportToCSV();
        });

        // Check password
        submitButton.addEventListener('click', () => {
            // Clear any previous error messages
            passwordError.style.display = 'none';

            if (passwordInput.value === PASSWORD) {
                passwordModal.classList.add('hidden');
                setTimeout(() => {
                    passwordModal.style.display = 'none';
                    analyticsContent.style.display = 'block';
                    loadAnalytics();
                }, 300); // Wait for animation to complete
            } else {
                passwordError.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
            }
        });

        // Enter key support
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitButton.click();
            }
        });

        // Load analytics data
        async function loadAnalytics() {
            try {
                const usersRef = collection(db, 'chat_users');
                const q = query(usersRef, orderBy('createdAt'));
                const querySnapshot = await getDocs(q);
                
                let totalUsers = 0;
                let totalChats = 0;
                let totalMessages = 0;
                usersData = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    totalUsers++;
                    totalChats += data.totalChats || 0;
                    totalMessages += data.totalMessages || 0;
                    
                    // Store user data for detailed view
                    usersData.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                const avgMessages = totalUsers > 0 ? (totalMessages / totalUsers).toFixed(1) : 0;
                
                // Update UI
                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('totalChats').textContent = totalChats;
                document.getElementById('totalMessages').textContent = totalMessages;
                document.getElementById('avgMessages').textContent = avgMessages;
                
                loading.style.display = 'none';
                analyticsGrid.style.display = 'grid';
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                loading.style.display = 'none';
                errorMessage.style.display = 'block';
            }
        }

        // Load detailed user information
        async function loadUserDetails() {
            try {
                usersLoading.querySelector('p').textContent = 'Loading user details...';
                usersLoading.style.display = 'block';
                usersTableContainer.style.display = 'none';
                
                if (usersData.length === 0) {
                    await loadAnalytics(); // Load data if not already loaded
                }
                
                usersTableBody.innerHTML = '';
                
                usersData.forEach(user => {
                    const row = document.createElement('tr');
                    
                    const createdAt = user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString() : 'N/A';
                    const lastActive = user.lastActiveAt ? new Date(user.lastActiveAt.toDate()).toLocaleDateString() : 'Never';
                    const status = user.lastActiveAt && 
                        (new Date() - user.lastActiveAt.toDate()) < 24 * 60 * 60 * 1000 ? 
                        'Active' : 'Inactive';
                    const statusClass = status === 'Active' ? 'status-active' : 'status-inactive';
                    
                    row.innerHTML = `
                        <td>${user.id.slice(0, 8)}...</td>
                        <td>${user.name || 'N/A'}</td>
                        <td>${user.company || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.phone || 'N/A'}</td>
                        <td>${user.totalChats || 0}</td>
                        <td>${user.totalMessages || 0}</td>
                        <td>${createdAt}</td>
                        <td>${lastActive}</td>
                        <td class="${statusClass}">${status}</td>
                    `;
                    
                    usersTableBody.appendChild(row);
                });
                
                usersLoading.style.display = 'none';
                usersTableContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading user details:', error);
                usersLoading.style.display = 'none';
                errorMessage.style.display = 'block';
            }
        }

        // Export data to CSV
        function exportToCSV() {
            if (usersData.length === 0) {
                alert('No data to export. Please load the analytics first.');
                return;
            }
            
            const headers = ['User ID', 'Name', 'Company', 'Email', 'Phone', 'Total Chats', 'Total Messages', 'Created At', 'Last Active'];
            const csvContent = [
                headers.join(','),
                ...usersData.map(user => [
                    user.id,
                    `"${user.name || ''}"`,
                    `"${user.company || ''}"`,
                    `"${user.email || ''}"`,
                    `"${user.phone || ''}"`,
                    user.totalChats || 0,
                    user.totalMessages || 0,
                    user.createdAt ? user.createdAt.toDate().toISOString() : '',
                    user.lastActive ? user.lastActive.toDate().toISOString() : ''
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `chat_analytics_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Focus password input on load
        passwordInput.focus();
    </script>
</body>
</html>